
@{
    Layout = null;
}

@model EF.Application.Model.Custom.c_Device

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <link href="~/Content/common.css" rel="stylesheet" />
    <link href="~/Scripts/layui/css/layui.css" rel="stylesheet" />
    <link href="~/Content/style.css" rel="stylesheet" />
    <script src="~/Scripts/echarts/echarts.js"></script>
    <script src="~/Scripts/jquery-1.8.0.js"></script>
    <script src="/google/js/api.js"></script>
    <script src="/google/js/drawing.js"></script>
    <script src="/google/js/geometry.js"></script>
    <script src="/google/js/places.js"></script>
    <script src="/google/js/maplabel.js"></script>
    <script src="/google/js/visualization.js"></script>
    <script src="/Scripts/map/bigMap.js"></script>
    <style type="text/css">
        .button-group {
            width: 120px;
            height: 60px;
            position: relative;
            bottom: 0px;
            left: calc(100% - 120px);
            font-size: 12px;
            padding: 10px;
            z-index: 9999;
        }

        .sbtj_Map {
            width: 100%;
            height: 400px;
        }

        .button-group .divbtn {
            width: 40px;
            height: 40px;
            background-color: #0D9BF2;
            float: left;
            margin-left: 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        .divbtn img {
            margin: 4px 0px 0px 4px;
        }
    </style>
</head>
<body>
    <blockquote class="layui-elem-quote layui-text">
        设备编辑
    </blockquote>
    <form action="" method="" id="deviceInfo" class="layui-form">
        @Html.HiddenFor(model => model.bigTypeId)
        @Html.HiddenFor(model => model.smallTypeId)
        @Html.HiddenFor(model => model.ElectricId)
        @Html.HiddenFor(model => model.LineId)
        @Html.HiddenFor(model=>model.parentId)
        @Html.HiddenFor(model => model.Id)
        @Html.HiddenFor(model=>model.deviceId)
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">设备名称:</label>
                <div class="layui-input-inline">
                    @Html.EditorFor(model => model.deviceName, new { htmlAttributes = new { @class = "layui-input" } })
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">设备ID:</label>
                <div class="layui-input-inline">
                    @Html.EditorFor(model => model.TerminalId, new { htmlAttributes = new { @class = "layui-input", @readonly = "readonly" } })
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label sbtj_label">设备大类:</label>
                <div class="layui-input-inline">
                    <div class="layui-input-inline">
                        <select name="quiz" id="deviceBigType" lay-filter="deviceBigType" lay-search=""></select>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label sbtj_label">设备小类:</label>
                <div class="layui-input-inline">
                    <div class="layui-input-inline">
                        <select name="quiz" id="deviceSmallType" lay-filter="deviceSmallType" lay-search=""></select>
                    </div>
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">SIM卡号:</label>
                <div class="layui-input-inline">
                    @Html.EditorFor(model => model.simNo, new { htmlAttributes = new { @class = "layui-input" } })
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">排序号:</label>
                <div class="layui-input-inline">
                    @Html.EditorFor(model => model.orderNo, new { htmlAttributes = new { @class = "layui-input" } })
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">安装人员:</label>
                <div class="layui-input-inline">
                    @Html.EditorFor(model => model.Installer, new { htmlAttributes = new { @class = "layui-input" } })
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">安装日期:</label>
                <div class="layui-input-inline">
                    @Html.EditorFor(model => model.InstallDate, new { htmlAttributes = new { @class = "layui-input" } })
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">生产厂家:</label>
                <div class="layui-input-inline">
                    @Html.EditorFor(model => model.manufacturer, new { htmlAttributes = new { @class = "layui-input" } })
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">供电或公司:</label>
                <div class="layui-input-inline">
                    <select name="quiz" id="ElectricSelect" disabled="disabled" lay-filter="ElectricSelect" lay-search=""></select>
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">线路名称:</label>
                <div class="layui-input-inline">
                    <select name="quiz" id="LineSelect" lay-filter="LineSelect" lay-search=""></select>
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">所在接头:</label>
                <div class="layui-input-inline">
                    <select name="quiz" id="JointSelect" lay-filter="JointSelect" lay-search=""></select>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">经度：</label>
                <div class="layui-input-inline">
                   @Html.EditorFor(model=>model.longitude, new { htmlAttributes = new { @class = "layui-input" } })
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">纬度:</label>
                <div class="layui-input-inline">
                   @Html.EditorFor(model => model.latitude, new { htmlAttributes = new { @class = "layui-input" } })
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">详细位置:</label>
            <div class="layui-input-block">
                @Html.EditorFor(model => model.localInstructions, new { htmlAttributes = new { @class = "layui-input" } })
            </div>
        </div>
        <div class="layui-form-item">
            <fieldset class="layui-elem-field site-demo-button" style="margin: 20px 0px 0px 20px;">
                <legend>地理位置</legend>
                <div class="sbtj_Map" id="mapDiv">
                    <div class="button-group">
                        <div class="divbtn" title="标注" onclick="javascript:switchCursor()">
                            <img src="~/Images/map/sign.png" />
                        </div>
                        <div class="divbtn" title="清除" onclick="javascript:ClearMarker(false)">
                            <img src="~/Images/map/clear.png" />
                        </div>
                    </div>
                </div>
            </fieldset>
        </div>
    </form>
    <button class="layui-btn layui-btn-normal" style="margin:0px 0px 0px 20px" id="commit">提交</button>
    <button class="layui-btn layui-btn-primary" onclick="window.history.back()">返回</button>
    <script src="~/Scripts/layui/layui.js"></script>
    <script type="text/javascript">
        layui.use(['form', 'laydate'], function () {
            var form = layui.form;
            form.on('select(deviceBigType)', function (data) {
                var Id = data.value;
                binSmallType(Id, false);
                $("#bigTypeId").val(Id);
                $("#smallTypeId").val("");
            });
            form.on('select(deviceSmallType)', function (data) {
                var Id = data.value;
                $("#smallTypeId").val(Id);
            });
            var laydate = layui.laydate;
            laydate.render({
                elem: '#InstallDate',
                type: 'datetime'
            });

            form.on('select(ElectricSelect)', function (data) {
                var Id = data.value;
                getLine(Id);
                $("#ElectricId").val(Id);
            });

            form.on('select(LineSelect)', function (data) {
                var Id = data.value;
                getJoint(Id);
                $("#LineId").val(Id);
            });

            form.on('select(JointSelect)', function (data) {
                var Id = data.value;
                $("#parentId").val(Id);
            });
        });

        /*初始化*/
        $(document).ready(function () {
            getElectric();
            var ElectricId = $("#ElectricId").val();
            getLine(ElectricId, true);
            var LineId = $("#LineId").val();
            getJoint(LineId, true);
            bindBigType();
            var smallId = $("#bigTypeId").val();
            binSmallType(smallId, true);
        });

        /*获取设备大类*/
        function bindBigType() {
            var url = "/DeviceManager/GetDeviceBigType";
            $.ajax({
                url: url,
                async: true,
                type: 'post',
                dataType: 'json',
                success: function (data, jqxhr, textStatus) {
                    var html = "<option value=''>请选择设备大类</option>";
                    $.each(data, function (idx, obj) {
                        html += "<option value=" + obj.Id + ">" + obj.typeName + "</option>";
                    });
                    $("#deviceBigType").html(html);
                    var value = $("#bigTypeId").val();
                    $("#deviceBigType").find("option[value='" + value + "']").prop("selected", true);
                    layui.use(['form'], function () {
                        var form = layui.form;
                        form.render('select');
                    });
                }, error: function (xhr, txtStatus) {
                    console.log(txtStatus);
                }
            });
        }

        /*获取设备小类*/
        function binSmallType(Id, obj) {
            if (Id == "" || Id == null || Id == "undefined") {
                Id = 0;
            }
            var url = "/DeviceManager/GetDeviceSmallType";
            $.ajax({
                url: url,
                type: 'post',
                data: { bigTypeId: Id },
                async: true,
                dataType: 'json',
                success: function (data, jqxhr, txtStatus) {
                    var html = "<option value=''>请选择设备小类</option>";
                    $.each(data, function (idx, obj) {
                        html += "<option value=" + obj.Id + ">" + obj.typeName + "</option>";
                    });
                    $("#deviceSmallType").html(html);
                    if (obj) {
                        var value = $("#smallTypeId").val();
                        $("#deviceSmallType").find("option[value='" + value + "']").prop("selected", true);
                    }
                    layui.use(['form'], function () {
                        var form = layui.form;
                        form.render('select');
                    });

                }, error: function (xhr, txtStatus) {
                    console.log(txtStatus);
                }
            });
        }


        /*获取供电*/
        function getElectric() {
            var url = "/DeviceInfo/GetElectric";
            $.ajax({
                url: url,
                async: true,
                type: 'post',
                dataType: 'json',
                success: function (data, jqxhr, txtStatus) {
                    var html = "<option value=''>请选择所在供电</option>";
                    $.each(data, function (idx, obj) {
                        html += "<option value=" + obj.Id + ">" + obj.name + "</option>";
                    });
                    $("#ElectricSelect").html(html);
                    var value = $("#ElectricId").val();
                    $("#ElectricSelect").find("option[value='" + value + "']").prop("selected", true);
                    layui.use(['form'], function () {
                        var form = layui.form;
                        form.render('select');
                    });
                }, error: function (xhr, txtStatus) {
                    console.log(txtStatus);
                }
            })
        }

        /*获取线路*/
        function getLine(Id, obj) {
            var url = "/DeviceInfo/GetLine";
            if (Id == "" || Id == null || Id == "undefined") {
                Id = -1;
            }
            $.ajax({
                url: url,
                async: true,
                type: 'post',
                data: { electricId: Id },
                dataType: 'json',
                success: function (data, jqxhr, txtStatus) {
                    var html = "<option value=''>请选择所在线路</option>";
                    $.each(data, function (idx, obj) {
                        html += "<option value=" + obj.Id + ">" + obj.name + "</option>";
                    });
                    $("#LineSelect").html(html);
                    if (obj) {
                        var value = $("#LineId").val();
                        $("#LineSelect").find("option[value='" + value + "']").prop("selected", true);
                    }
                    layui.use(['form'], function () {
                        var form = layui.form;
                        form.render('select');
                    });
                }, error: function (xhr, txtStatus) {
                    console.log(txtStatus);
                }
            })
        }

        /*获取接头*/
        function getJoint(Id, obj) {
            var url = "/DeviceInfo/GetJoint";
            if (Id == "" || Id == null || Id == "undefined") {
                Id = -1;
            }
            $.ajax({
                url: url,
                async: true,
                type: 'post',
                data: { LineId: Id },
                dataType: 'json',
                success: function (data, jqxhr, txtStatus) {
                    var html = "<option value=''>请选择所在接头</option>";
                    $.each(data, function (idx, obj) {
                        html += "<option value=" + obj.Id + ">" + obj.name + "</option>";
                    });
                    $("#JointSelect").html(html);
                    if (obj) {
                        var value = $("#parentId").val();
                        $("#JointSelect").find("option[value='" + value + "']").prop("selected", true);
                    }
                    layui.use(['form'], function () {
                        var form = layui.form;
                        form.render('select');
                    });
                }, error: function (xhr, txtStatus) {
                    console.log(txtStatus);
                }
            })
        }

        $.fn.serializeObject = function () {
            var o = {};
            var a = this.serializeArray();
            $.each(a, function () {
                if (o[this.name]) {
                    if (!o[this.name].push) {
                        o[this.name] = [o[this.name]];
                    }
                    o[this.name].push(this.value || '');
                } else {
                    o[this.name] = this.value || '';
                }
            });
            return o;
        };

        /*监听提交按钮*/
        document.getElementById("commit").addEventListener("click", function () {
            var data = $("#deviceInfo").serializeObject();
            if (data.bigTypeId == null || data.bigTypeId == "" || data.bigTypeId == "undefind") {
                layer.alert('请选择设备大类!', { title: "提示" });
                return;
            }
            if (data.smallTypeId == null || data.smallTypeId == "" || data.smallTypeId == "undefind") {
                layer.alert('请选择设备大类!', { title: "提示" });
                return;
            }
            var url = "/DeviceInfo/editComit"
            $.ajax({
                url:url,
                type: 'post',
                async:true,
                data:data,
                dataType: 'json',
                success: function (data, jqxhr, txtStatus) {
                    if (data.code == 0) {
                        layer.msg(data.msg);
                        window.top.initTree();
                        var url="/DeviceInfo/Index";
                        setTimeout(function () {
                            window.top.frameUrl(url);
                        }, 3000);
                    } else {
                        layer.msg(data.msg);
                    }
                }, error: function (xhr, txtStatus) {
                    console.log(txtStatus);
                }
            })
        });

        /*加载地图*/
        $(function () {
            var bigmaps = bigmap.prototype;
            var mapcontainer = document.getElementById("mapDiv");
            var map = bigmaps.init(mapOption, myOption, mapcontainer);
            var html = "<div class='button-group'><div class='divbtn' title='标注' id='drawPoint'><img src='/Images/map/sign.png' /></div><div class='divbtn' title='清除' id='clearPoint'><img src='/Images/map/clear.png' /></div></div>";
            $("#mapDiv").append(html);
            var lngobj = document.getElementById("longitude");
            var latobj = document.getElementById("latitude");
            markerOption.icon = "/Images/location.png";
            var draw_Manager;
            document.getElementById("drawPoint").addEventListener("click", function () {
                draw_Manager = bigmaps.addDraw(markerOption, polylineOption, polygonOption, rectangleOption, circleOption, drawOption, map);
                //开启绘点
                bigmaps.setDrawMarker(draw_Manager);
                //监听绘点
                bigmaps.setlistenDrawMarker(draw_Manager, latobj, lngobj);
            });

            document.getElementById("clearPoint").addEventListener("click", function () {
                //停止绘制
                bigmaps.setStopDraw(draw_Manager);
                //清除绘点
                bigmaps.clearDraw(arrayOption.markerArray);
                lngobj.value = null;
                latobj.value = null;
                bigmaps.clearMap(marker);
            });
            var x = $("#longitude").val();
            var y = $("#latitude").val();
            if (x && y) {
                markerOption.id = $("#TerminalId").val();
                var obj = { "position": { "lat": parseFloat(y), "lng": parseFloat(x) } };
                markerOption.position = obj.position;
                var marker = bigmaps.addMarker(markerOption, map);
                bigmaps.moveTo(map, x, y);
            }
        })
    </script>
</body>
</html>
